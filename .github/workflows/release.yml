name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run tests
        run: go test -v ./...

      - name: Build binaries
        run: |
          mkdir -p dist
          
          # Windows
          GOOS=windows GOARCH=amd64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-windows-amd64.exe .
          GOOS=windows GOARCH=arm64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-windows-arm64.exe .
          
          # Linux
          GOOS=linux GOARCH=amd64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-linux-amd64 .
          GOOS=linux GOARCH=arm64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-linux-arm64 .
          GOOS=linux GOARCH=arm go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-linux-arm .
          
          # macOS
          GOOS=darwin GOARCH=amd64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-macos-amd64 .
          GOOS=darwin GOARCH=arm64 go build -ldflags="-X 'github.com/spf13/cobra.version=1.4.1'" -o dist/delguard-macos-arm64 .

      - name: Create checksums
        run: |
          cd dist
          sha256sum * > checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: DelGuard ${{ github.ref_name }}
          body: |
            ## ğŸš€ DelGuard ${{ github.ref_name }}
            
            è·¨å¹³å°å®‰å…¨åˆ é™¤å·¥å…·ï¼Œä¸€é”®å®‰è£…ï¼Œä¿æŠ¤æ‚¨çš„æ–‡ä»¶å®‰å…¨ã€‚
            
            ### âœ¨ æ–°åŠŸèƒ½
            - **ä¸€è¡Œå‘½ä»¤å®‰è£…**ï¼šæ”¯æŒWindowsã€Linuxã€macOSçš„ä¸€è¡Œå‘½ä»¤å®‰è£…
            - **è‡ªåŠ¨æ£€æµ‹å¹³å°**ï¼šæ™ºèƒ½æ£€æµ‹æ“ä½œç³»ç»Ÿå’Œæ¶æ„
            - **ç‰ˆæœ¬é€‰æ‹©**ï¼šæ”¯æŒæŒ‡å®šç‰ˆæœ¬å®‰è£…
            - **å¼ºåˆ¶é‡è£…**ï¼šæ”¯æŒå¼ºåˆ¶é‡æ–°å®‰è£…
            
            ### ğŸ“¦ å®‰è£…æ–¹æ³•
            
            #### Windows (PowerShell)
            ```powershell
            powershell -Command "& { [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12; Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/quick-install.ps1' -OutFile 'quick-install.ps1'; .\quick-install.ps1 }"
            ```
            
            #### Linux/macOS (Bash)
            ```bash
            curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/quick-install.sh | sudo bash
            ```
            
            #### æ‰‹åŠ¨ä¸‹è½½
            ä»ä¸‹æ–¹ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè§£å‹åè¿è¡Œï¼š
            ```bash
            delguard install
            ```
            
            ### ğŸ“‹ ç³»ç»Ÿæ”¯æŒ
            - **Windows**: Windows 10/11 (x64, ARM64)
            - **Linux**: Ubuntu 18.04+, CentOS 7+, ç­‰ (x64, ARM64, ARM)
            - **macOS**: macOS 10.14+ (Intel, Apple Silicon)
            
            ### ğŸ”— å¿«é€Ÿå¼€å§‹
            ```bash
            # å®‰å…¨åˆ é™¤æ–‡ä»¶
            rm file.txt  # æˆ– del file.txt (Windows)
            
            # æŸ¥çœ‹å›æ”¶ç«™
            delguard list
            
            # æ¢å¤æ–‡ä»¶
            delguard restore file.txt
            
            # æŸ¥çœ‹å¸®åŠ©
            delguard --help
            ```
            
            ### ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§
            - æ–‡ä»¶è¯¯åˆ ä¿æŠ¤
            - ç®¡ç†å‘˜æƒé™éªŒè¯
            - åŸå§‹å‘½ä»¤å¤‡ä»½
            - è¯¦ç»†æ“ä½œæ—¥å¿—
            
            ### ğŸ“– æ–‡æ¡£
            - [å®Œæ•´æ–‡æ¡£](README.md)
            - [å®‰è£…æŒ‡å—](INSTALL.md)
            - [ä½¿ç”¨æ•™ç¨‹](https://github.com/${{ github.repository }}/wiki)
          files: |
            dist/*
            scripts/quick-install.ps1
            scripts/quick-install.sh
            INSTALL.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
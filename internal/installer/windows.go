package installer

import (
	"fmt"
	"os"
	"os/exec"
	"path/filepath"
	"strings"
)

// WindowsInstaller Windowsç³»ç»Ÿå®‰è£…å™¨
type WindowsInstaller struct {
	config *InstallConfig
}

// NewWindowsInstaller åˆ›å»ºWindowså®‰è£…å™¨
func NewWindowsInstaller() *WindowsInstaller {
	return &WindowsInstaller{
		config: GetDefaultInstallConfig(),
	}
}

// Install åœ¨Windowsä¸Šå®‰è£…DelGuard
func (w *WindowsInstaller) Install() error {
	fmt.Println("ğŸ”§ å¼€å§‹åœ¨Windowsä¸Šå®‰è£…DelGuard...")

	// æ£€æŸ¥æƒé™
	if w.config.SystemWide && !IsRunningAsAdmin() {
		return fmt.Errorf("ç³»ç»Ÿçº§å®‰è£…éœ€è¦ç®¡ç†å‘˜æƒé™ï¼Œè¯·ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ")
	}

	// åˆ›å»ºå®‰è£…ç›®å½•
	if err := os.MkdirAll(w.config.InstallPath, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºå®‰è£…ç›®å½•å¤±è´¥: %v", err)
	}

	if err := os.MkdirAll(w.config.BackupPath, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºå¤‡ä»½ç›®å½•å¤±è´¥: %v", err)
	}

	// è·å–å½“å‰å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„
	currentExe, err := os.Executable()
	if err != nil {
		return fmt.Errorf("è·å–å½“å‰å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„å¤±è´¥: %v", err)
	}

	// å¤åˆ¶DelGuardåˆ°å®‰è£…ç›®å½•
	targetExe := filepath.Join(w.config.InstallPath, "delguard.exe")
	if err := w.copyFile(currentExe, targetExe); err != nil {
		return fmt.Errorf("å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶å¤±è´¥: %v", err)
	}

	// åˆ›å»ºå‘½ä»¤åˆ«åè„šæœ¬
	if err := w.createCommandAliases(targetExe); err != nil {
		return fmt.Errorf("åˆ›å»ºå‘½ä»¤åˆ«åå¤±è´¥: %v", err)
	}

	// æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡
	if err := w.addToPath(); err != nil {
		return fmt.Errorf("æ·»åŠ åˆ°PATHå¤±è´¥: %v", err)
	}

	// åˆ›å»ºPowerShellé…ç½®æ–‡ä»¶
	if err := w.createPowerShellProfile(); err != nil {
		fmt.Printf("âš ï¸ åˆ›å»ºPowerShellé…ç½®æ–‡ä»¶å¤±è´¥: %v\n", err)
		fmt.Println("   æ‚¨å¯èƒ½éœ€è¦æ‰‹åŠ¨é…ç½®PowerShellåˆ«å")
	}

	fmt.Println("âœ… DelGuardå®‰è£…å®Œæˆï¼")
	fmt.Println("ğŸ“ å®‰è£…ä¿¡æ¯:")
	fmt.Printf("   å®‰è£…è·¯å¾„: %s\n", w.config.InstallPath)
	fmt.Printf("   å¤‡ä»½è·¯å¾„: %s\n", w.config.BackupPath)
	fmt.Println("ğŸ”„ è¯·é‡æ–°å¯åŠ¨ç»ˆç«¯æˆ–è¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ·æ–°ç¯å¢ƒ:")
	fmt.Println("   refreshenv  # æˆ–é‡æ–°æ‰“å¼€PowerShell")

	return nil
}

// Uninstall å¸è½½DelGuard
func (w *WindowsInstaller) Uninstall() error {
	fmt.Println("ğŸ—‘ï¸ å¼€å§‹å¸è½½DelGuard...")

	// ä»PATHä¸­ç§»é™¤
	if err := w.removeFromPath(); err != nil {
		fmt.Printf("âš ï¸ ä»PATHç§»é™¤å¤±è´¥: %v\n", err)
	}

	// åˆ é™¤PowerShellé…ç½®
	if err := w.removePowerShellProfile(); err != nil {
		fmt.Printf("âš ï¸ åˆ é™¤PowerShellé…ç½®å¤±è´¥: %v\n", err)
	}

	// åˆ é™¤å®‰è£…ç›®å½•
	if err := os.RemoveAll(w.config.InstallPath); err != nil {
		return fmt.Errorf("åˆ é™¤å®‰è£…ç›®å½•å¤±è´¥: %v", err)
	}

	fmt.Println("âœ… DelGuardå¸è½½å®Œæˆï¼")
	fmt.Println("ğŸ”„ è¯·é‡æ–°å¯åŠ¨ç»ˆç«¯ä»¥å®Œå…¨æ¸…é™¤ç¯å¢ƒå˜é‡")

	return nil
}

// IsInstalled æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
func (w *WindowsInstaller) IsInstalled() bool {
	targetExe := filepath.Join(w.config.InstallPath, "delguard.exe")
	_, err := os.Stat(targetExe)
	return err == nil
}

// GetInstallPath è·å–å®‰è£…è·¯å¾„
func (w *WindowsInstaller) GetInstallPath() string {
	return w.config.InstallPath
}

// BackupOriginalCommands å¤‡ä»½åŸå§‹å‘½ä»¤ï¼ˆWindowsé€šå¸¸ä¸éœ€è¦ï¼‰
func (w *WindowsInstaller) BackupOriginalCommands() error {
	// Windowsçš„å†…ç½®å‘½ä»¤ä¸éœ€è¦å¤‡ä»½
	return nil
}

// RestoreOriginalCommands æ¢å¤åŸå§‹å‘½ä»¤
func (w *WindowsInstaller) RestoreOriginalCommands() error {
	// Windowsçš„å†…ç½®å‘½ä»¤ä¸éœ€è¦æ¢å¤
	return nil
}

// createCommandAliases åˆ›å»ºå‘½ä»¤åˆ«åè„šæœ¬
func (w *WindowsInstaller) createCommandAliases(delguardPath string) error {
	// åˆ›å»ºdel.batè„šæœ¬
	delScript := fmt.Sprintf(`@echo off
REM DelGuard safe delete wrapper for 'del' command
"%s" delete %%*
`, delguardPath)

	delBat := filepath.Join(w.config.InstallPath, "del.bat")
	if err := os.WriteFile(delBat, []byte(delScript), 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºdel.batå¤±è´¥: %v", err)
	}

	// åˆ›å»ºrmdir.batè„šæœ¬
	rmdirScript := fmt.Sprintf(`@echo off
REM DelGuard safe delete wrapper for 'rmdir' command
"%s" delete %%* -r
`, delguardPath)

	rmdirBat := filepath.Join(w.config.InstallPath, "rmdir.bat")
	if err := os.WriteFile(rmdirBat, []byte(rmdirScript), 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºrmdir.batå¤±è´¥: %v", err)
	}

	return nil
}

// createPowerShellProfile åˆ›å»ºPowerShellé…ç½®æ–‡ä»¶
func (w *WindowsInstaller) createPowerShellProfile() error {
	// è·å–PowerShellé…ç½®æ–‡ä»¶è·¯å¾„
	profilePath, err := w.getPowerShellProfilePath()
	if err != nil {
		return err
	}

	// ç¡®ä¿é…ç½®æ–‡ä»¶ç›®å½•å­˜åœ¨
	profileDir := filepath.Dir(profilePath)
	if err := os.MkdirAll(profileDir, 0755); err != nil {
		return fmt.Errorf("åˆ›å»ºPowerShellé…ç½®ç›®å½•å¤±è´¥: %v", err)
	}

	// DelGuardé…ç½®å†…å®¹
	delguardPath := filepath.Join(w.config.InstallPath, "delguard.exe")
	configContent := fmt.Sprintf(`
# DelGuard Safe Delete Tool Configuration
# Auto-generated by DelGuard installer

# DelGuardå®‰å…¨åˆ é™¤å·¥å…·åˆ«å
function del {
    & "%s" delete $args
}

function rm {
    & "%s" delete $args
}

function rmdir {
    & "%s" delete $args -r
}

# DelGuardå·¥å…·åˆ«å
function delguard {
    & "%s" $args
}

Write-Host "DelGuard Safe Delete Tool Loaded" -ForegroundColor Green
Write-Host "Commands: del, rm, cp, copy, delguard" -ForegroundColor Cyan
Write-Host "Use 'delguard --help' for detailed help" -ForegroundColor Yellow
`, delguardPath, delguardPath, delguardPath, delguardPath)

	// è¯»å–ç°æœ‰é…ç½®æ–‡ä»¶
	var existingContent string
	if content, err := os.ReadFile(profilePath); err == nil {
		existingContent = string(content)
	}

	// æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«DelGuardé…ç½®
	if strings.Contains(existingContent, "DelGuard Safe Delete Tool Configuration") {
		// æ›¿æ¢ç°æœ‰é…ç½®
		lines := strings.Split(existingContent, "\n")
		var newLines []string
		skipMode := false

		for _, line := range lines {
			if strings.Contains(line, "DelGuard Safe Delete Tool Configuration") {
				skipMode = true
				continue
			}
			if skipMode && strings.TrimSpace(line) == "" && len(newLines) > 0 && strings.TrimSpace(newLines[len(newLines)-1]) == "" {
				skipMode = false
			}
			if !skipMode {
				newLines = append(newLines, line)
			}
		}

		existingContent = strings.Join(newLines, "\n")
	}

	// å†™å…¥æ–°é…ç½®
	finalContent := existingContent + configContent
	if err := os.WriteFile(profilePath, []byte(finalContent), 0644); err != nil {
		return fmt.Errorf("å†™å…¥PowerShellé…ç½®æ–‡ä»¶å¤±è´¥: %v", err)
	}

	return nil
}

// removePowerShellProfile åˆ é™¤PowerShellé…ç½®
func (w *WindowsInstaller) removePowerShellProfile() error {
	profilePath, err := w.getPowerShellProfilePath()
	if err != nil {
		return err
	}

	// è¯»å–ç°æœ‰é…ç½®æ–‡ä»¶
	content, err := os.ReadFile(profilePath)
	if err != nil {
		return nil // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— éœ€åˆ é™¤
	}

	existingContent := string(content)

	// ç§»é™¤DelGuardé…ç½®
	if strings.Contains(existingContent, "DelGuard Safe Delete Tool Configuration") {
		lines := strings.Split(existingContent, "\n")
		var newLines []string
		skipMode := false

		for _, line := range lines {
			if strings.Contains(line, "DelGuard Safe Delete Tool Configuration") {
				skipMode = true
				continue
			}
			if skipMode && strings.TrimSpace(line) == "" && len(newLines) > 0 && strings.TrimSpace(newLines[len(newLines)-1]) == "" {
				skipMode = false
				continue
			}
			if !skipMode {
				newLines = append(newLines, line)
			}
		}

		finalContent := strings.Join(newLines, "\n")
		return os.WriteFile(profilePath, []byte(finalContent), 0644)
	}

	return nil
}

// getPowerShellProfilePath è·å–PowerShellé…ç½®æ–‡ä»¶è·¯å¾„
func (w *WindowsInstaller) getPowerShellProfilePath() (string, error) {
	// å°è¯•è·å–PowerShell 7çš„é…ç½®æ–‡ä»¶è·¯å¾„
	homeDir, err := os.UserHomeDir()
	if err != nil {
		return "", err
	}

	// PowerShell 7 é…ç½®æ–‡ä»¶è·¯å¾„
	ps7Profile := filepath.Join(homeDir, "Documents", "PowerShell", "Microsoft.PowerShell_profile.ps1")

	// æ£€æŸ¥PowerShell 7æ˜¯å¦å­˜åœ¨
	if _, err := exec.LookPath("pwsh"); err == nil {
		return ps7Profile, nil
	}

	// å›é€€åˆ°Windows PowerShell 5.x
	ps5Profile := filepath.Join(homeDir, "Documents", "WindowsPowerShell", "Microsoft.PowerShell_profile.ps1")
	return ps5Profile, nil
}

// addToPath æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡
func (w *WindowsInstaller) addToPath() error {
	if w.config.SystemWide {
		return w.addToSystemPath()
	}
	return w.addToUserPath()
}

// removeFromPath ä»PATHç¯å¢ƒå˜é‡ç§»é™¤
func (w *WindowsInstaller) removeFromPath() error {
	if w.config.SystemWide {
		return w.removeFromSystemPath()
	}
	return w.removeFromUserPath()
}

// addToUserPath æ·»åŠ åˆ°ç”¨æˆ·PATH
func (w *WindowsInstaller) addToUserPath() error {
	return w.modifyUserPath(true)
}

// removeFromUserPath ä»ç”¨æˆ·PATHç§»é™¤
func (w *WindowsInstaller) removeFromUserPath() error {
	return w.modifyUserPath(false)
}

// modifyUserPath ä¿®æ”¹ç”¨æˆ·PATH
func (w *WindowsInstaller) modifyUserPath(add bool) error {
	// ä½¿ç”¨PowerShellä¿®æ”¹ç”¨æˆ·ç¯å¢ƒå˜é‡
	var script string
	if add {
		script = fmt.Sprintf(`
$path = [Environment]::GetEnvironmentVariable("PATH", "User")
if ($path -notlike "*%s*") {
    $newPath = $path + ";%s"
    [Environment]::SetEnvironmentVariable("PATH", $newPath, "User")
    Write-Host "Added to user PATH"
} else {
    Write-Host "Already in user PATH"
}
`, w.config.InstallPath, w.config.InstallPath)
	} else {
		script = fmt.Sprintf(`
$path = [Environment]::GetEnvironmentVariable("PATH", "User")
$newPath = $path -replace ";?%s;?", ""
$newPath = $newPath -replace "^;|;$", ""
[Environment]::SetEnvironmentVariable("PATH", $newPath, "User")
Write-Host "Removed from user PATH"
`, strings.ReplaceAll(w.config.InstallPath, `\`, `\\`))
	}

	cmd := exec.Command("powershell", "-Command", script)
	return cmd.Run()
}

// addToSystemPath æ·»åŠ åˆ°ç³»ç»ŸPATHï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
func (w *WindowsInstaller) addToSystemPath() error {
	return w.modifySystemPath(true)
}

// removeFromSystemPath ä»ç³»ç»ŸPATHç§»é™¤ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
func (w *WindowsInstaller) removeFromSystemPath() error {
	return w.modifySystemPath(false)
}

// modifySystemPath ä¿®æ”¹ç³»ç»ŸPATH
func (w *WindowsInstaller) modifySystemPath(add bool) error {
	// ä½¿ç”¨PowerShellä¿®æ”¹ç³»ç»Ÿç¯å¢ƒå˜é‡ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
	var script string
	if add {
		script = fmt.Sprintf(`
$path = [Environment]::GetEnvironmentVariable("PATH", "Machine")
if ($path -notlike "*%s*") {
    $newPath = $path + ";%s"
    [Environment]::SetEnvironmentVariable("PATH", $newPath, "Machine")
    Write-Host "Added to system PATH"
} else {
    Write-Host "Already in system PATH"
}
`, w.config.InstallPath, w.config.InstallPath)
	} else {
		script = fmt.Sprintf(`
$path = [Environment]::GetEnvironmentVariable("PATH", "Machine")
$newPath = $path -replace ";?%s;?", ""
$newPath = $newPath -replace "^;|;$", ""
[Environment]::SetEnvironmentVariable("PATH", $newPath, "Machine")
Write-Host "Removed from system PATH"
`, strings.ReplaceAll(w.config.InstallPath, `\`, `\\`))
	}

	cmd := exec.Command("powershell", "-Command", script)
	return cmd.Run()
}

// copyFile å¤åˆ¶æ–‡ä»¶
func (w *WindowsInstaller) copyFile(src, dst string) error {
	sourceFile, err := os.Open(src)
	if err != nil {
		return err
	}
	defer sourceFile.Close()

	destFile, err := os.Create(dst)
	if err != nil {
		return err
	}
	defer destFile.Close()

	_, err = destFile.ReadFrom(sourceFile)
	return err
}

// isWindowsAdmin æ£€æŸ¥æ˜¯å¦ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œ
func isWindowsAdmin() bool {
	// ç®€åŒ–çš„ç®¡ç†å‘˜æƒé™æ£€æŸ¥
	// å°è¯•åœ¨ç³»ç»Ÿç›®å½•åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ£€æµ‹æƒé™
	tempFile := filepath.Join(os.Getenv("WINDIR"), "temp", "delguard_admin_test.tmp")
	file, err := os.Create(tempFile)
	if err != nil {
		return false
	}
	file.Close()
	os.Remove(tempFile)
	return true
}
